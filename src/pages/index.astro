---
// This page handles the root URL
// Handles Netlify Identity tokens before redirecting to the default language
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Redirecting... | RomaNET</title>
        <!-- Netlify Identity Widget - will auto-initialize when it detects a token -->
        <script
            is:inline
            src="https://identity.netlify.com/v1/netlify-identity-widget.js"
        ></script>
    </head>
    <body>
        <p id="status">Loading...</p>

        <script is:inline>
            (function () {
                var hash = window.location.hash;
                var hasIdentityToken =
                    hash &&
                    (hash.indexOf("invite_token=") !== -1 ||
                        hash.indexOf("confirmation_token=") !== -1 ||
                        hash.indexOf("recovery_token=") !== -1 ||
                        hash.indexOf("access_token=") !== -1);

                if (!hasIdentityToken) {
                    // No token, redirect immediately
                    window.location.replace("/en/");
                    return;
                }

                // We have a token - update status and let the widget handle it
                document.getElementById("status").textContent =
                    "Processing invitation...";

                // Wait for netlifyIdentity to be available (it auto-initializes with the token)
                function setupHandlers() {
                    if (typeof netlifyIdentity === "undefined") {
                        setTimeout(setupHandlers, 100);
                        return;
                    }

                    // DO NOT call init() - the widget auto-initializes on its own
                    // Just set up the event handlers

                    // Handle successful login/signup
                    netlifyIdentity.on("login", function (user) {
                        document.getElementById("status").textContent =
                            "Success! Redirecting to admin...";
                        setTimeout(function () {
                            window.location.href = "/admin/";
                        }, 500);
                    });

                    // Handle close without login
                    netlifyIdentity.on("close", function () {
                        setTimeout(function () {
                            var user = netlifyIdentity.currentUser();
                            if (!user) {
                                document.getElementById("status").textContent =
                                    "Redirecting to homepage...";
                                window.location.href = "/en/";
                            }
                        }, 300);
                    });

                    // Handle errors
                    netlifyIdentity.on("error", function (err) {
                        document.getElementById("status").textContent =
                            "Error: " + err.message;
                        console.error("Netlify Identity error:", err);
                    });
                }

                // Start setting up handlers
                setupHandlers();
            })();
        </script>
    </body>
</html>
