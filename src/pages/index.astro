---
// This page handles the root URL
// We need to handle Netlify Identity tokens before redirecting to the default language
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Redirecting... | RomaNET</title>
        <!-- Load Netlify Identity Widget ONCE -->
        <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"
        ></script>
    </head>
    <body>
        <p id="status">Loading...</p>

        <script>
            (function () {
                var hash = window.location.hash;
                var hasIdentityToken =
                    hash &&
                    (hash.indexOf("invite_token=") !== -1 ||
                        hash.indexOf("confirmation_token=") !== -1 ||
                        hash.indexOf("recovery_token=") !== -1 ||
                        hash.indexOf("access_token=") !== -1);

                if (!hasIdentityToken) {
                    // No token, redirect immediately
                    window.location.replace("/en/");
                    return;
                }

                // We have a token - update status
                document.getElementById("status").textContent =
                    "Processing invitation...";

                // Wait for netlifyIdentity to be available
                function initIdentity() {
                    if (typeof netlifyIdentity === "undefined") {
                        setTimeout(initIdentity, 100);
                        return;
                    }

                    // Initialize with API URL
                    netlifyIdentity.init({
                        APIUrl: "https://romanet.netlify.app/.netlify/identity",
                    });

                    // The widget should auto-detect the token and open
                    // But let's also explicitly open it after a short delay
                    setTimeout(function () {
                        netlifyIdentity.open();
                    }, 500);

                    // Handle successful login/signup
                    netlifyIdentity.on("login", function (user) {
                        document.getElementById("status").textContent =
                            "Success! Redirecting to admin...";
                        setTimeout(function () {
                            window.location.href = "/admin/";
                        }, 500);
                    });

                    // Handle close without login
                    netlifyIdentity.on("close", function () {
                        setTimeout(function () {
                            var user = netlifyIdentity.currentUser();
                            if (!user) {
                                document.getElementById("status").textContent =
                                    "Redirecting to homepage...";
                                window.location.href = "/en/";
                            }
                        }, 300);
                    });

                    // Handle errors
                    netlifyIdentity.on("error", function (err) {
                        document.getElementById("status").textContent =
                            "Error: " + err.message;
                        console.error("Netlify Identity error:", err);
                    });
                }

                // Start the initialization
                initIdentity();
            })();
        </script>
    </body>
</html>
